<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jackie's Helpful Forms</title>
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="shortcut icon" href="favicon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Helpful Forms">
  <meta name="theme-color" content="#a259ff">
  <style>
/* ========== Base Styles ========== */
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  padding: 20px;
  background-color: #f9f9f9;
  color: #333;
  max-width: 1400px;
  margin: 0 auto;
}

h1 {
  font-size: 24px;
  display: flex;
  align-items: center;
  margin-bottom: 20px;
}

h1 img {
  height: 32px;
  margin-right: 10px;
}

.refresh-icon {
  margin-left: 12px;
  font-size: 20px;
  cursor: pointer;
  color: #666;
  transition: transform 0.3s, color 0.2s;
  user-select: none;
}

.refresh-icon:hover {
  color: #007bff;
  transform: rotate(180deg);
}

.refresh-icon:active {
  transform: rotate(180deg) scale(0.95);
}

h2 {
  font-size: 20px;
  display: flex;
  align-items: center;
  margin-bottom: 0;
}

/* ========== Collapsible Sections ========== */
.service-section {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-bottom: 16px;
  overflow: hidden;
}

.service-header {
  display: flex;
  align-items: center;
  padding: 16px;
  cursor: pointer;
  background: #fff;
  border: none;
  width: 100%;
  text-align: left;
  font-size: 18px;
  font-weight: 600;
  transition: background-color 0.2s;
}

.service-header:hover {
  background-color: #f5f5f5;
}

.service-header.disabled {
  cursor: not-allowed;
  opacity: 0.5;
  background-color: #fafafa;
}

.collapse-icon {
  margin-left: auto;
  font-size: 20px;
  transition: transform 0.3s;
}

.service-header.expanded .collapse-icon {
  transform: rotate(90deg);
}

.service-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
  padding: 0 16px;
}

.service-content.expanded {
  max-height: 5000px;
  padding: 16px;
  transition: max-height 0.5s ease-in;
  overflow: visible;
}

/* Nested collapsible for admin functions */
.admin-section {
  margin-top: 12px;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  background: #fafafa;
}

.admin-header {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  cursor: pointer;
  background: #fafafa;
  border: none;
  width: 100%;
  text-align: left;
  font-size: 14px;
  font-weight: 500;
  color: #666;
  transition: background-color 0.2s;
}

.admin-header:hover {
  background-color: #f0f0f0;
}

.admin-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
  padding: 0 12px;
}

.admin-content.expanded {
  max-height: 1000px;
  padding: 12px;
  transition: max-height 0.5s ease-in;
}

a {
  margin-top: 20px;          /* spacing for plain text links */
  color: #6c3fcf;
  text-decoration: none;
  overflow: visible;
}

a:hover {
  text-decoration: underline;
}

/* ========== Controls / Filters ========== */
.controls {
  display: flex;
  flex-wrap: wrap;     /* allow items to wrap on small screens */
  align-items: center;
  gap: 8px;            /* space between buttons/dropdown */
  margin: 0;
  line-height: 1.2;
  font-size: 12px;
  padding-right: 6px;  /* avoid clipping borders on the right */
}

label,
.filter-label {
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  min-height: 29px;
  margin: 0;
  margin-top: 4px;
  vertical-align: middle;
}

#filterSelect {
  font-size: 12px;
}

select {
  padding: 3px 8px;
  font-size: 12px;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  line-height: 13px;
  box-sizing: border-box;
  vertical-align: middle;
  min-height: 29px;
  height: 29px;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin: 0;
  margin-top: 4px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-color: #fff;
  background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3e%3cpolyline points="6 9 12 15 18 9"%3e%3c/polyline%3e%3c/svg%3e');
  background-repeat: no-repeat;
  background-position: right 4px center;
  background-size: 16px;
  padding-right: 24px;
}

/* Style input fields to align with buttons and dropdowns */
input[type="text"] {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 12px;
  line-height: 13px;
  padding: 3px 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
  vertical-align: middle;
  min-height: 29px;
  height: 29px;
  margin: 0;
  margin-top: 4px;
}

/* ========== Buttons (shared) ========== */
.btn {
  /* Display & Box Model */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  margin: 0;
  margin-top: 4px;
  padding: 3px 8px;
  min-height: 29px;
  height: 29px;

  /* Typography */
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 12px;
  font-weight: normal;
  line-height: 13px;
  text-align: center;
  text-decoration: none;
  white-space: nowrap;

  /* Colors & Borders */
  color: #007bff;
  background-color: #fff;
  border: 0.8px solid #007bff;
  border-radius: 4px;

  /* Layout */
  vertical-align: middle;
  flex-shrink: 0;

  /* Interaction */
  cursor: pointer;
  -webkit-user-select: none;
  user-select: none;

  /* Remove default button styling - Safari/iOS specific */
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  touch-action: manipulation;
}

/* Force exact same styles for button elements */
button.btn {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  border: 0.8px solid #007bff !important;
  padding: 3px 8px !important;
  min-height: 29px !important;
  height: 29px !important;
  background-color: #fff !important;
  color: #007bff !important;
  font-size: 12px !important;
  font-weight: 400 !important;
  line-height: 13px !important;
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
  font-synthesis: none !important;
}

/* Force exact same styles for link elements */
a.btn {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  border: 0.8px solid #007bff !important;
  padding: 3px 8px !important;
  min-height: 29px !important;
  height: 29px !important;
  background-color: #fff !important;
  color: #007bff !important;
  font-size: 12px !important;
  font-weight: 400 !important;
  line-height: 13px !important;
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
  font-synthesis: none !important;
}

.btn:hover {
  background-color: #e6f0ff;
  color: #0056b3;
  text-decoration: none;
}

/* Active state for better mobile feedback */
.btn:active {
  background-color: #cce5ff;
  transform: scale(0.98);
}

/* Focus state for accessibility */
.btn:focus {
  outline: 2px solid #80bdff;
  outline-offset: 2px;
}

/* ========== Tables ========== */
.table-wrapper {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin-top: 12px;
}

table {
  width: 100%;
  margin-top: 12px;
  border-collapse: collapse;
}

th,
td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

th {
  background: #f3f3f3;
}

#dataTable th,
#dataTable td,
#ivaTable th,
#ivaTable td,
#healthTable th,
#healthTable td,
#incomeTable th,
#incomeTable td {
  vertical-align: middle;
  padding: 8px;
  font-size: 12px;
}

/* Hide Importados column (6th column, index 5) on mobile for IVA table */
@media (max-width: 768px) {
  #ivaTable th:nth-child(6),
  #ivaTable td:nth-child(6) {
    display: none;
  }
}

/* IVA Done/Undo button styles */
.iva-done-btn {
  background-color: #e8f5e9 !important;
  border-color: #4caf50 !important;
  color: #2e7d32 !important;
  margin-left: 8px;
}

.iva-done-btn:hover {
  background-color: #c8e6c9 !important;
}

.iva-undo-btn {
  background-color: #fff3e0 !important;
  border-color: #ff9800 !important;
  color: #e65100 !important;
  margin-left: 8px;
}

.iva-undo-btn:hover {
  background-color: #ffe0b2 !important;
}

.iva-done-btn:disabled,
.iva-undo-btn:disabled {
  opacity: 0.6;
  cursor: wait;
}

/* Work Done/Undo button styles */
.work-done-btn {
  background-color: #e8f5e9 !important;
  border-color: #4caf50 !important;
  color: #2e7d32 !important;
  margin-left: 8px;
}

.work-done-btn:hover {
  background-color: #c8e6c9 !important;
}

.work-undo-btn {
  background-color: #fff3e0 !important;
  border-color: #ff9800 !important;
  color: #e65100 !important;
  margin-left: 8px;
}

.work-undo-btn:hover {
  background-color: #ffe0b2 !important;
}

.work-done-btn:disabled,
.work-undo-btn:disabled {
  opacity: 0.6;
  cursor: wait;
}

/* Health Done/Undo button styles */
.health-done-btn {
  background-color: #e8f5e9 !important;
  border-color: #4caf50 !important;
  color: #2e7d32 !important;
  margin-left: 8px;
}

.health-done-btn:hover {
  background-color: #c8e6c9 !important;
}

.health-undo-btn {
  background-color: #fff3e0 !important;
  border-color: #ff9800 !important;
  color: #e65100 !important;
  margin-left: 8px;
}

.health-undo-btn:hover {
  background-color: #ffe0b2 !important;
}

.health-done-btn:disabled,
.health-undo-btn:disabled {
  opacity: 0.6;
  cursor: wait;
}

td a,
#dataTable td a,
#ivaTable td a,
#healthTable td a,
#incomeTable td a {
  display: inline-block;
  margin: 0;
  padding: 0;
  font-size: 12px;
  line-height: 1.2;
  color: #6c3fcf;
  text-decoration: none;
  vertical-align: middle;
}

</style>

</head>

<body>
  <h1>
    <img src="favicon.png" alt="Icon" style="height: 32px; margin-right: 10px;">
    Jackie's Helpful Forms
    <span class="refresh-icon" onclick="refreshPage()" title="Refresh page">üîÑ</span>
  </h1>

  <!-- Work Expenses Section -->
  <div class="service-section">
    <button class="service-header" onclick="toggleService('travel')">
      <span>Work Expenses</span>
      <span class="collapse-icon">‚ñ∂</span>
    </button>
    <div class="service-content" id="travel-content">
<div class="controls">
  <a href="https://forms.gle/Efmbz5brKNyohqQe7"
     target="_blank"
     rel="noopener"
     class="btn">New Expense</a>

  <button class="btn refresh-btn" type="button">Refresh</button>

  <label for="filterSelect" class="filter-label">
    Filter by expense reason:
    <select id="filterSelect">
      <option value="">-- All --</option>
    </select>
  </label>
</div>

<!-- Manage Expense Reasons Admin Section -->
<div class="admin-section">
  <button class="admin-header" onclick="toggleAdmin('travel-admin')">
    <span>Manage Expense Reasons</span>
    <span class="collapse-icon" style="margin-left: auto;">‚ñº</span>
  </button>
  <div class="admin-content" id="travel-admin">
    <!-- Add Expense Reason controls -->
    <div class="add-trip" style="margin-bottom:8px;">
      <label for="newTripName" style="margin-right:0.5rem; display:block; margin-bottom:4px;">
        ‚ûï Add expense reason:
      </label>
      <input id="newTripName"
             type="text"
             placeholder="e.g. 20251025 Paris"
             style="width:calc(100% - 60px); margin-right:4px;" />
      <button class="btn" type="button" onclick="addTrip()">Add</button>
    </div>

    <!-- Delete Expense Reason controls -->
    <div class="delete-trip">
      <label for="deleteTripSelect" style="margin-right:0.5rem; display:block; margin-bottom:4px;">
        üóëÔ∏è Delete expense reason:
      </label>
      <select id="deleteTripSelect" style="width:calc(100% - 80px); margin-right:4px;">
        <option value="">-- Select expense reason --</option>
      </select>
      <button class="btn" type="button" onclick="deleteTrip()">Delete</button>
    </div>
  </div>
</div><!-- end admin-section -->

<!-- Status messages below the admin section -->
<p id="addTripResult" style="margin-top:0.5rem; margin-bottom:0; font-size:12px; color:#333;"></p>
<p id="deleteResult" style="margin-top:0; margin-bottom:0.5rem; font-size:12px; color:#333;"></p>

<div class="table-wrapper">
  <table id="dataTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

    </div><!-- end travel-content -->
  </div><!-- end service-section -->

  <!-- IVA Claims Section -->
  <div class="service-section">
    <button class="service-header" onclick="toggleService('iva')">
      <span>IVA Claim Receipts</span>
      <span class="collapse-icon">‚ñ∂</span>
    </button>
    <div class="service-content" id="iva-content">
  <div class="controls">
  <a href="https://docs.google.com/forms/d/1XxVzHE-Ch_vBdJQuz8WPiq7esTKqSnLcyLGapeA_eIM/viewform" target="_blank" rel="noopener" class="btn">New IVA Receipt</a>

  <button class="btn refresh-btn" type="button">Refresh</button>

  <label for="ivaFilterSelect" class="filter-label">
    Filter by Status:
    <select id="ivaFilterSelect">
      <option value="">-- All --</option>
    </select>
  </label>
  <p class="filter-label"><b>JALLC NIF:</b> 508462037</p>
  <p class="filter-label"><b>Tipo:</b> Functionarios de Embaixadas e Organismos Internacionais</p>
  <p class="filter-label"><b>My NIF:</b> 256120803</p>

</div>

<div class="table-wrapper">
  <table id="ivaTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

    </div><!-- end iva-content -->
  </div><!-- end service-section -->

  <!-- Health Claim Section -->
  <div class="service-section">
    <button class="service-header" onclick="toggleService('health')">
      <span>Health Claim</span>
      <span class="collapse-icon">‚ñ∂</span>
    </button>
    <div class="service-content" id="health-content">
  <div class="controls">
  <a href="https://docs.google.com/forms/d/1p1ajhtU8BXu05Qlc6WGIT-UrxNbyhpeJVzsOa-9t-f4/viewform" target="_blank" rel="noopener" class="btn">New Claim</a>

  <button class="btn refresh-btn" type="button">Refresh</button>

  <label for="healthFilterSelect" class="filter-label">
    Filter by Status:
    <select id="healthFilterSelect">
      <option value="">-- All --</option>
    </select>
  </label>
</div>

<div class="table-wrapper">
  <table id="healthTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

    </div><!-- end health-content -->
  </div><!-- end service-section -->

  <!-- Log Income Section -->
  <div class="service-section">
    <button class="service-header" onclick="toggleService('income')">
      <span>Log Income</span>
      <span class="collapse-icon">‚ñ∂</span>
    </button>
    <div class="service-content" id="income-content">
  <div class="controls">
  <a href="https://docs.google.com/forms/d/1ZV81p4SPWxuz-7sQtoOYYsz7xxSkiUiAOQgIcHBbK5A/viewform" target="_blank" rel="noopener" class="btn">New Income</a>

  <button class="btn refresh-btn" type="button">Refresh</button>

  <label for="incomeFilterSelect" class="filter-label">
    Filter by Status:
    <select id="incomeFilterSelect">
      <option value="">-- All --</option>
    </select>
  </label>
</div>

<div class="table-wrapper">
  <table id="incomeTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

    </div><!-- end income-content -->
  </div><!-- end service-section -->

<script>
/* ========= CONFIG - Injected from .env via build script ========= */
const SPREADSHEET_ID = '1J4dldGjb3SktoVxQD3BKm-iX6RDAF7YjoLImm7-MIsg';
const TRAVEL_SHEET_NAME = 'Work!A:J'; // Extended to include Status column (J)
const IVA_SHEET_NAME = 'IVA!A:J';
const HEALTH_SHEET_NAME = 'Health!B:L';
const INCOME_SHEET_NAME = 'Income!B:H';
const TRAVEL_FILTER_COLUMN_INDEX = 1; // "Expense Reason" column (now index 1 after reordering)
const IVA_FILTER_COLUMN_INDEX = 1; // "N√∫mero (Fatura Ref Number)" column (B in sheet, index 1)
const HEALTH_FILTER_COLUMN_INDEX = 10; // "Status" column (L in sheet, but index 10 in B:L range)
const INCOME_FILTER_COLUMN_INDEX = 6; // "Status" column (H in sheet, but index 6 in B:H range)
const SHEETS_API_KEY = 'AIzaSyCkQIbYsNr6ooub1lJysGoSflG9bka0fbs';

/* --- DELETE endpoint config --- */
const DELETE_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyAg6E8J4X6AvkE0pr2sOncfP0N_ATWCKaRmtNELtMoDFRw_61oJwoaxQOckScqtx3vFQ/exec';
const DELETE_API_KEY = 'auAzKQaDBNGZyXYWlcN1yTW2xAROTjlM';
/* ============================ */

/* ---------- Helper: Format date as yyyy-mm-dd ---------- */
function formatDateYMD(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr; // Return original if invalid
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  } catch (e) {
    return dateStr; // Return original on error
  }
}


/* ---------- Load Travel Sheet Data ---------- */
const travelEndpoint = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(TRAVEL_SHEET_NAME)}?key=${SHEETS_API_KEY}&majorDimension=ROWS`;
let allTravelRows = [];

async function loadTravelSheet() {
  const res = await fetch(travelEndpoint);
  if (!res.ok) {
    console.error('Sheets API error (Travel)', await res.text());
    return;
  }
  const j = await res.json();
  const rows = j.values || [];
  if (rows.length === 0) return;

  const headers = rows[0];
  // Reorder: Status (J=9) first, then A-G (0-6), skip H (7), I (8)
  // Display: Status, Expense Reason, Date, (unused), Amount, Currency, Description, Link to File
  const reorderedHeaders = [
    headers[9] || 'Status', // J: Status
    headers[0], // A: Expense Reason
    headers[1], // B: Date
    headers[3], // D: Amount
    headers[4], // E: Currency
    headers[5], // F: Description
    'Link to File' // G: File link
  ];

  // Reorder data rows: Status first, then useful columns, plus original row number
  allTravelRows = rows.slice(1).map((row, index) => [
    row[9] || '', // J: Status
    row[0], // A: Expense Reason
    row[1], // B: Date
    row[3], // D: Amount
    row[4], // E: Currency
    row[5], // F: Description
    row[6], // G: File link
    index + 2 // Original sheet row number (for API calls)
  ]);

  // build header row
  document.querySelector('#dataTable thead').innerHTML =
    '<tr>' + reorderedHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';

  // populate filter dropdown and delete dropdown with unique expense reasons
  const set = new Set(allTravelRows.map(r => (r[TRAVEL_FILTER_COLUMN_INDEX] || '').trim()).filter(x => x !== ''));
  const sortedReasons = Array.from(set).sort();

  // Populate filter dropdown
  const filterSelect = document.getElementById('filterSelect');
  filterSelect.innerHTML = '<option value="">Show all expense reasons</option>';
  sortedReasons.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val; opt.textContent = val;
    filterSelect.appendChild(opt);
  });

  // Populate delete dropdown
  const deleteSelect = document.getElementById('deleteTripSelect');
  deleteSelect.innerHTML = '<option value="">-- Select expense reason --</option>';
  sortedReasons.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val; opt.textContent = val;
    deleteSelect.appendChild(opt);
  });

  renderTravelTable(allTravelRows);
}

/* ---------- Load IVA Sheet Data ---------- */
const ivaEndpoint = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(IVA_SHEET_NAME)}?key=${SHEETS_API_KEY}&majorDimension=ROWS`;
let allIvaRows = [];

async function loadIvaSheet() {
  const res = await fetch(ivaEndpoint);
  if (!res.ok) {
    console.error('Sheets API error (IVA)', await res.text());
    return;
  }
  const j = await res.json();
  const rows = j.values || [];
  if (rows.length === 0) return;

  const headers = rows[0];
  // Exclude Timestamp (column A, index 0) and reorder columns
  // Original: A=Timestamp, B=N√∫mero, C=Data, D=Emitente NIF, E=Tipo, F=Importados, G=Valor do IVA, H=Valor Total, I=Ficheiro, J=Status
  // Display: J, B, C, D, E, F, G, H, (Link to File from I)
  const reorderedHeaders = [
    headers[9], // J: Status
    headers[1], // B: N√∫mero
    headers[2], // C: Data
    headers[3], // D: Emitente NIF
    headers[4], // E: Tipo
    headers[5], // F: Importados
    headers[6], // G: Valor do IVA
    headers[7], // H: Valor Total
    'Link to File' // Link from I
  ];

  // Reorder data rows (exclude column A, reorder remaining)
  // Store original sheet row number (index + 2: +1 for 0-indexing, +1 for header)
  allIvaRows = rows.slice(1).map((row, index) => [
    row[9], // J: Status
    row[1], // B: N√∫mero
    row[2], // C: Data
    row[3], // D: Emitente NIF
    row[4], // E: Tipo
    row[5], // F: Importados
    row[6], // G: Valor do IVA
    row[7], // H: Valor Total
    row[8], // I: Ficheiro (will be converted to link)
    index + 2 // Original sheet row number (for API calls)
  ]);

  // build header row
  document.querySelector('#ivaTable thead').innerHTML =
    '<tr>' + reorderedHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';

  // populate filter dropdown with unique Status values
  const set = new Set(allIvaRows.map(r => (r[0] || '').trim()).filter(x => x !== ''));
  const sortedStatuses = Array.from(set).sort();

  // Populate IVA filter dropdown
  const ivaFilterSelect = document.getElementById('ivaFilterSelect');
  ivaFilterSelect.innerHTML = '<option value="">-- All --</option>';
  sortedStatuses.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val; opt.textContent = val;
    ivaFilterSelect.appendChild(opt);
  });

  renderIvaTable(allIvaRows);
}

/* ---------- Load Health Sheet Data ---------- */
const healthEndpoint = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(HEALTH_SHEET_NAME)}?key=${SHEETS_API_KEY}&majorDimension=ROWS`;
let allHealthRows = [];

async function loadHealthSheet() {
  const res = await fetch(healthEndpoint);
  if (!res.ok) {
    console.error('Sheets API error (Health)', await res.text());
    return;
  }
  const j = await res.json();
  const rows = j.values || [];
  if (rows.length === 0) return;

  const headers = rows[0];
  // Original: B=col0, C=col1, D=col2, E=col3, F=col4, G=col5, H=col6, I=col7, J=col8, K=col9, L=col10
  // Display: L (Status), then B through I, then links from J and K
  const reorderedHeaders = [
    headers[10], // L: Status (first)
    ...headers.slice(0, 8), // B through I
    'Link to Receipt', // Link from J
    'Link to Invoice' // Link from K
  ];

  // Reorder data rows: Status first, then B-I, then J and K as links, plus original row number
  allHealthRows = rows.slice(1).map((row, index) => [
    row[10], // L: Status
    ...row.slice(0, 8), // B through I
    row[8],  // J: Receipt (will be converted to link)
    row[9],  // K: Invoice (will be converted to link, may be empty)
    index + 2 // Original sheet row number (for API calls)
  ]);

  // build header row
  document.querySelector('#healthTable thead').innerHTML =
    '<tr>' + reorderedHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';

  // populate filter dropdown with unique Status values (now at index 0 in reordered data)
  const set = new Set(allHealthRows.map(r => (r[0] || '').trim()).filter(x => x !== ''));
  const sortedStatuses = Array.from(set).sort();

  // Populate Health filter dropdown
  const healthFilterSelect = document.getElementById('healthFilterSelect');
  healthFilterSelect.innerHTML = '<option value="">-- All --</option>';
  sortedStatuses.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val; opt.textContent = val;
    healthFilterSelect.appendChild(opt);
  });

  renderHealthTable(allHealthRows);
}

/* ---------- Load Income Sheet Data ---------- */
const incomeEndpoint = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(INCOME_SHEET_NAME)}?key=${SHEETS_API_KEY}&majorDimension=ROWS`;
let allIncomeRows = [];

async function loadIncomeSheet() {
  const res = await fetch(incomeEndpoint);
  if (!res.ok) {
    console.error('Sheets API error (Income)', await res.text());
    return;
  }
  const j = await res.json();
  const rows = j.values || [];
  if (rows.length === 0) return;

  const headers = rows[0];
  // Original: B=col0, C=col1, D=col2, E=col3, F=col4, G=col5, H=col6
  // Display: H (Status), then B through G
  const reorderedHeaders = [
    headers[6], // H: Status (first)
    ...headers.slice(0, 6) // B through G
  ];

  // Reorder data rows: Status first, then B-G
  allIncomeRows = rows.slice(1).map(row => [
    row[6], // H: Status
    ...row.slice(0, 6) // B through G
  ]);

  // build header row
  document.querySelector('#incomeTable thead').innerHTML =
    '<tr>' + reorderedHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';

  // populate filter dropdown with unique Status values (now at index 0 in reordered data)
  const set = new Set(allIncomeRows.map(r => (r[0] || '').trim()).filter(x => x !== ''));
  const sortedStatuses = Array.from(set).sort();

  // Populate Income filter dropdown
  const incomeFilterSelect = document.getElementById('incomeFilterSelect');
  incomeFilterSelect.innerHTML = '<option value="">-- All --</option>';
  sortedStatuses.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val; opt.textContent = val;
    incomeFilterSelect.appendChild(opt);
  });

  renderIncomeTable(allIncomeRows);
}

function renderTravelTable(rows) {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  rows.forEach((r, rowIndex) => {
    const tr = document.createElement('tr');
    // Only render first 7 columns (0-6), skip index 7 which is the internal sheet row number
    const cells = r.slice(0, 7).map((c, i) => {
      if (i === 0) { // Status column - add Done/Undo button
        const status = (c || '').trim();
        const isClaimed = status.toLowerCase().startsWith('claimed');
        const buttonText = isClaimed ? '‚Ü© Undo' : '‚úì Done';
        const buttonClass = isClaimed ? 'btn work-undo-btn' : 'btn work-done-btn';
        return `<td>${c || ''} <button class="${buttonClass}" data-row-index="${rowIndex}" onclick="toggleWorkStatus(${rowIndex})">${buttonText}</button></td>`;
      }
      if (i === 6 && c) { // Link to File column
        const safeUrl = c.startsWith('http') ? c : 'https://' + c;
        return `<td><a href="${safeUrl}" target="_blank" rel="noopener">Link</a></td>`;
      }
      return `<td>${c || ''}</td>`;
    }).join('');
    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });
}

function renderIvaTable(rows) {
  const tbody = document.querySelector('#ivaTable tbody');
  tbody.innerHTML = '';
  rows.forEach((r, rowIndex) => {
    const tr = document.createElement('tr');
    // Only render first 9 columns (0-8), skip index 9 which is the internal sheet row number
    const cells = r.slice(0, 9).map((c, i) => {
      if (i === 0) { // Status column - add Done/Undo button
        const status = (c || '').trim();
        const isClaimed = status.toLowerCase().startsWith('claimed');
        const buttonText = isClaimed ? '‚Ü© Undo' : '‚úì Done';
        const buttonClass = isClaimed ? 'btn iva-undo-btn' : 'btn iva-done-btn';
        return `<td>${c || ''} <button class="${buttonClass}" data-row-index="${rowIndex}" onclick="toggleIvaStatus(${rowIndex})">${buttonText}</button></td>`;
      }
      if (i === 2 && c) { // Data column - format as yyyy-mm-dd
        const dateVal = formatDateYMD(c);
        return `<td>${dateVal}</td>`;
      }
      if (i === 8 && c) { // column 9 in display (index 8) = Link to File from Ficheiro
        const safeUrl = c.startsWith('http') ? c : 'https://' + c;
        return `<td><a href="${safeUrl}" target="_blank" rel="noopener">Link</a></td>`;
      }
      return `<td>${c || ''}</td>`;
    }).join('');
    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });
}

function renderHealthTable(rows) {
  const tbody = document.querySelector('#healthTable tbody');
  tbody.innerHTML = '';
  rows.forEach((r, rowIndex) => {
    const tr = document.createElement('tr');
    // Only render first 11 columns (0-10), skip index 11 which is the internal sheet row number
    const cells = r.slice(0, 11).map((c, i) => {
      if (i === 0) { // Status column - add Done/Undo button
        const status = (c || '').trim();
        const isClaimed = status.toLowerCase().startsWith('claimed');
        const buttonText = isClaimed ? '‚Ü© Undo' : '‚úì Done';
        const buttonClass = isClaimed ? 'btn health-undo-btn' : 'btn health-done-btn';
        return `<td>${c || ''} <button class="${buttonClass}" data-row-index="${rowIndex}" onclick="toggleHealthStatus(${rowIndex})">${buttonText}</button></td>`;
      }
      // Index 9 = Link to Receipt (from J)
      if (i === 9 && c) {
        const safeUrl = c.startsWith('http') ? c : 'https://' + c;
        return `<td><a href="${safeUrl}" target="_blank" rel="noopener">Link</a></td>`;
      }
      // Index 10 = Link to Invoice (from K) - may be empty
      if (i === 10) {
        if (c && c.trim() !== '') {
          const safeUrl = c.startsWith('http') ? c : 'https://' + c;
          return `<td><a href="${safeUrl}" target="_blank" rel="noopener">Link</a></td>`;
        }
        return `<td></td>`; // Empty cell if no invoice
      }
      return `<td>${c || ''}</td>`;
    }).join('');
    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });
}

function renderIncomeTable(rows) {
  const tbody = document.querySelector('#incomeTable tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    const cells = r.map((c, i) => {
      return `<td>${c || ''}</td>`;
    }).join('');
    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });
}

document.getElementById('filterSelect').addEventListener('change', function() {
  const v = this.value;
  const filtered = v ? allTravelRows.filter(r => (r[TRAVEL_FILTER_COLUMN_INDEX] || '') === v) : allTravelRows;
  renderTravelTable(filtered);
});

/* ---------- Toggle Work Status (Done/Undo) ---------- */
async function toggleWorkStatus(displayRowIndex) {
  // Get the row data from the currently displayed/filtered rows
  const filterValue = document.getElementById('filterSelect').value;
  const displayedRows = filterValue ? allTravelRows.filter(r => (r[TRAVEL_FILTER_COLUMN_INDEX] || '') === filterValue) : allTravelRows;
  const rowData = displayedRows[displayRowIndex];

  if (!rowData) {
    alert('Error: Could not find row data');
    return;
  }

  const sheetRow = rowData[7]; // Original sheet row number (stored at index 7)
  const currentStatus = (rowData[0] || '').trim();
  const isClaimed = currentStatus.toLowerCase().startsWith('claimed');
  const fileUrl = rowData[6]; // File URL at index 6

  // Disable the button while processing
  const button = document.querySelector(`#dataTable button[data-row-index="${displayRowIndex}"]`);
  if (button) {
    button.disabled = true;
    button.textContent = 'Working...';
  }

  try {
    const res = await fetch(DELETE_WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "toggleWorkStatus",
        sheetRow: sheetRow,
        currentStatus: currentStatus,
        fileUrl: fileUrl,
        apiKey: DELETE_API_KEY
      })
    });

    const result = await res.json();
    if (result.success) {
      // Reload the Travel sheet to reflect changes and force re-render
      await loadTravelSheet();
      // Reapply filter if one is selected
      const currentFilter = document.getElementById('filterSelect').value;
      if (currentFilter) {
        const filtered = allTravelRows.filter(r => (r[TRAVEL_FILTER_COLUMN_INDEX] || '') === currentFilter);
        renderTravelTable(filtered);
      }
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
      // Re-enable button on error
      if (button) {
        button.disabled = false;
        button.textContent = isClaimed ? '‚Ü© Undo' : '‚úì Done';
      }
    }
  } catch (err) {
    alert('Network error: ' + err);
    // Re-enable button on error
    if (button) {
      button.disabled = false;
      button.textContent = isClaimed ? '‚Ü© Undo' : '‚úì Done';
    }
  }
}

document.getElementById('ivaFilterSelect').addEventListener('change', function() {
  const v = this.value;
  const filtered = v ? allIvaRows.filter(r => (r[0] || '') === v) : allIvaRows; // Filter by Status (first column)
  renderIvaTable(filtered);
});

/* ---------- Toggle IVA Status (Done/Undo) ---------- */
async function toggleIvaStatus(displayRowIndex) {
  // Get the row data from the currently displayed/filtered rows
  const filterValue = document.getElementById('ivaFilterSelect').value;
  const displayedRows = filterValue ? allIvaRows.filter(r => (r[0] || '') === filterValue) : allIvaRows;
  const rowData = displayedRows[displayRowIndex];

  if (!rowData) {
    alert('Error: Could not find row data');
    return;
  }

  const sheetRow = rowData[9]; // Original sheet row number (stored at index 9)
  const currentStatus = (rowData[0] || '').trim();
  const isClaimed = currentStatus.toLowerCase().startsWith('claimed');
  const numero = rowData[1]; // N√∫mero for file rename
  const data = rowData[2]; // Data (invoice date) for file rename on undo
  const fileUrl = rowData[8]; // File URL

  // Disable the button while processing
  const button = document.querySelector(`#ivaTable button[data-row-index="${displayRowIndex}"]`);
  if (button) {
    button.disabled = true;
    button.textContent = 'Working...';
  }

  try {
    const res = await fetch(DELETE_WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "toggleIvaStatus",
        sheetRow: sheetRow,
        currentStatus: currentStatus,
        numero: numero,
        data: data,
        fileUrl: fileUrl,
        apiKey: DELETE_API_KEY
      })
    });

    const result = await res.json();
    if (result.success) {
      // Reload the IVA sheet to reflect changes and force re-render
      await loadIvaSheet();
      // Reapply filter if one is selected
      const currentFilter = document.getElementById('ivaFilterSelect').value;
      if (currentFilter) {
        const filtered = allIvaRows.filter(r => (r[0] || '') === currentFilter);
        renderIvaTable(filtered);
      }
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
      // Re-enable button on error
      if (button) {
        button.disabled = false;
        button.textContent = isClaimed ? '‚Ü© Undo' : '‚úì Done';
      }
    }
  } catch (err) {
    alert('Network error: ' + err);
    // Re-enable button on error
    if (button) {
      button.disabled = false;
      button.textContent = isClaimed ? '‚Ü© Undo' : '‚úì Done';
    }
  }
}

/* ---------- Toggle Health Status (Done/Undo) ---------- */
async function toggleHealthStatus(displayRowIndex) {
  // Get the row data from the currently displayed/filtered rows
  const filterValue = document.getElementById('healthFilterSelect').value;
  const displayedRows = filterValue ? allHealthRows.filter(r => (r[0] || '') === filterValue) : allHealthRows;
  const rowData = displayedRows[displayRowIndex];

  if (!rowData) {
    alert('Error: Could not find row data');
    return;
  }

  const sheetRow = rowData[11]; // Original sheet row number (stored at index 11)
  const currentStatus = (rowData[0] || '').trim();
  const isClaimed = currentStatus.toLowerCase().startsWith('claimed');
  const fileUrl = rowData[9]; // Receipt file URL at index 9

  // Disable the button while processing
  const button = document.querySelector(`#healthTable button[data-row-index="${displayRowIndex}"]`);
  if (button) {
    button.disabled = true;
    button.textContent = 'Working...';
  }

  try {
    const res = await fetch(DELETE_WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "toggleHealthStatus",
        sheetRow: sheetRow,
        currentStatus: currentStatus,
        fileUrl: fileUrl,
        apiKey: DELETE_API_KEY
      })
    });

    const result = await res.json();
    if (result.success) {
      // Reload the Health sheet to reflect changes and force re-render
      await loadHealthSheet();
      // Reapply filter if one is selected
      const currentFilter = document.getElementById('healthFilterSelect').value;
      if (currentFilter) {
        const filtered = allHealthRows.filter(r => (r[0] || '') === currentFilter);
        renderHealthTable(filtered);
      }
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
      // Re-enable button on error
      if (button) {
        button.disabled = false;
        button.textContent = isClaimed ? '‚Ü© Undo' : '‚úì Done';
      }
    }
  } catch (err) {
    alert('Network error: ' + err);
    // Re-enable button on error
    if (button) {
      button.disabled = false;
      button.textContent = isClaimed ? '‚Ü© Undo' : '‚úì Done';
    }
  }
}

document.getElementById('healthFilterSelect').addEventListener('change', function() {
  const v = this.value;
  const filtered = v ? allHealthRows.filter(r => (r[0] || '') === v) : allHealthRows; // Filter by Status (first column in reordered data)
  renderHealthTable(filtered);
});

document.getElementById('incomeFilterSelect').addEventListener('change', function() {
  const v = this.value;
  const filtered = v ? allIncomeRows.filter(r => (r[0] || '') === v) : allIncomeRows; // Filter by Status (first column in reordered data)
  renderIncomeTable(filtered);
});

document.querySelectorAll('.refresh-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    // Save expanded state before reload
    const expandedSections = [];
    document.querySelectorAll('.service-content.expanded').forEach(content => {
      expandedSections.push(content.id);
    });
    sessionStorage.setItem('expandedSections', JSON.stringify(expandedSections));
    location.reload();
  });
});

/* ---------- Add Expense Reason Function ---------- */
async function addTrip() {
  const tripName = document.getElementById("newTripName").value.trim();
  if (!tripName) {
    alert("Please enter an expense reason");
    return;
  }

  const resultEl = document.getElementById("addTripResult");
  resultEl.textContent = "Adding expense reason...";
  resultEl.style.color = '#333';

  try {
    const res = await fetch(DELETE_WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "addTrip",
        tripName: tripName,
        apiKey: DELETE_API_KEY
      })
    });

    const data = await res.json();
    if (data.success) {
      resultEl.textContent = `Expense reason "${data.expenseReason || data.tripName}" added to form dropdown.`;
      resultEl.style.color = '#2d7a2d';
      document.getElementById("newTripName").value = ''; // clear input
      loadTravelSheet(); // refresh dropdowns
    } else {
      resultEl.textContent = `Error: ${data.error || "unknown"}`;
      resultEl.style.color = '#c72e2e';
    }
  } catch (err) {
    resultEl.textContent = "Network or permission error: " + err;
    resultEl.style.color = '#c72e2e';
  }
}

/* ---------- Delete Expense Reason Function ---------- */
async function deleteTrip() {
  const trip = document.getElementById("deleteTripSelect").value.trim();
  if (!trip) {
    alert("Please select an expense reason to delete");
    return;
  }

  const resultEl = document.getElementById("deleteResult");
  resultEl.textContent = "Working‚Ä¶";

  try {
    const res = await fetch(DELETE_WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify({
        tripName: trip,
        apiKey: DELETE_API_KEY
      })
    });

    const data = await res.json();
    if (data.success) {
      resultEl.textContent =
        `Deleted ${data.deletedRows} expense row(s) for "${data.expenseReason || data.trip}". `
        + `${data.remainingReasons || data.remainingTrips} expense reason(s) remain in list.`;
      resultEl.style.color = '#2d7a2d'; // green for success
      loadTravelSheet(); // refresh table after deletion
    } else {
      resultEl.textContent = `Error: ${data.error || "unknown"}`;
      resultEl.style.color = '#c72e2e'; // red for error
    }
  } catch (err) {
    resultEl.textContent = "Network or permission error: " + err;
    resultEl.style.color = '#c72e2e'; // red for error
  }
}

/* ---------- Restore expanded sections after refresh ---------- */
function restoreExpandedSections() {
  const expandedSections = sessionStorage.getItem('expandedSections');
  if (expandedSections) {
    const sections = JSON.parse(expandedSections);
    sections.forEach(sectionId => {
      const content = document.getElementById(sectionId);
      if (content) {
        content.classList.add('expanded');
        // Find and expand the corresponding header
        const header = content.previousElementSibling;
        if (header && header.classList.contains('service-header')) {
          header.classList.add('expanded');
        }
      }
    });
    // Clear the stored state
    sessionStorage.removeItem('expandedSections');
  }
}

/* ---------- Load data on page start ---------- */
loadTravelSheet();
loadIvaSheet();
loadHealthSheet();
loadIncomeSheet();
restoreExpandedSections();

/* ---------- Toggle Functions for Collapsible Sections ---------- */
function toggleService(serviceId) {
  const content = document.getElementById(serviceId + '-content');
  const header = event.currentTarget;

  if (content.classList.contains('expanded')) {
    content.classList.remove('expanded');
    header.classList.remove('expanded');
  } else {
    content.classList.add('expanded');
    header.classList.add('expanded');
  }
}

function toggleAdmin(adminId) {
  const content = document.getElementById(adminId);
  const header = event.currentTarget;
  const icon = header.querySelector('.collapse-icon');

  if (content.classList.contains('expanded')) {
    content.classList.remove('expanded');
    icon.textContent = '‚ñº';
  } else {
    content.classList.add('expanded');
    icon.textContent = '‚ñ≤';
  }
}

/* ---------- Refresh Page Function ---------- */
function refreshPage() {
  // Clear any saved expanded sections state
  sessionStorage.removeItem('expandedSections');
  // Reload the page
  location.reload();
}
</script>


</body>
</html>
