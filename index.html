<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jackie's Helpful Forms</title>
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="shortcut icon" href="favicon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Helpful Forms">
  <meta name="theme-color" content="#a259ff">
  <style>
/* ========== Base Styles ========== */
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  padding: 20px;
  background-color: #f9f9f9;
  color: #333;
}

h1 {
  font-size: 24px;
  display: flex;
  align-items: center;
}

h1 img {
  height: 32px;
  margin-right: 10px;
}

h2 {
  font-size: 20px;
  display: flex;
  align-items: center;
  margin-bottom: 0;
}

a {
  margin-top: 20px;          /* spacing for plain text links */
  color: #6c3fcf;
  text-decoration: none;
  overflow: visible;
}

a:hover {
  text-decoration: underline;
}

/* ========== Controls / Filters ========== */
.controls {
  display: flex;
  flex-wrap: wrap;     /* allow items to wrap on small screens */
  align-items: center;
  gap: 8px;            /* space between buttons/dropdown */
  margin: 0;
  line-height: 1.2;
  font-size: 12px;
  padding-right: 6px;  /* avoid clipping borders on the right */
}

label,
.filter-label,
#filterSelect {
  font-size: 12px;
}

select {
  padding: 6px;
}

/* ========== Buttons (shared) ========== */
.btn {
  display: inline-block;
  background-color: #fff;
  color: #007bff;
  border: 0.5px solid #007bff;
  border-radius: 4px;
  padding: 5px 21px;
  cursor: pointer;
  text-align: center;
  text-decoration: none;  /* removes underline on <a> */
  font-size: 12px;
  font-family: inherit;   /* or pick a specific font */
  font-weight: normal;    /* ensures no bolding */
  margin-top: 4px;
  white-space: nowrap;     /* keep text on one line */
  box-sizing: border-box;  /* include border in width */
  line-height: 1.2;   /* or whatever looks right */
flex-shrink: 0;          /* no flex squeez */
}

.btn:hover {
  background-color: #e6f0ff;
  color: #0056b3;
  text-decoration: none;
}

/* ========== Tables ========== */
table {
  width: 100%;
  margin-top: 12px;
  border-collapse: collapse;
}

th,
td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

th {
  background: #f3f3f3;
}

#dataTable th,
#dataTable td {
  vertical-align: middle;
  padding: 8px;
  font-size: 12px;
}

td a,
#dataTable td a {
  display: inline-block;
  margin: 0;
  padding: 0;
  font-size: 12px;
  line-height: 1.2;
  color: #6c3fcf;
  text-decoration: none;
  vertical-align: middle;
}

</style>

</head>

<body>
  <h1>
    <img src="favicon.png" alt="Icon" style="height: 32px; margin-right: 10px;">
    Jackie's Helpful Forms
  </h1>

  <!--  START of Travel Expenses Section -->
  <h2>Travel Expenses</h2>
<div class="controls">
  <a href="https://forms.gle/Efmbz5brKNyohqQe7"
     target="_blank"
     rel="noopener"
     class="btn">New Expense</a>

  <button class="btn refresh-btn" type="button">Refresh</button>

  <label for="filterSelect" class="filter-label">
    Filter by trip:
    <select id="filterSelect">
      <option value="">-- All --</option>
    </select>
  </label>

  <!-- Add Trip controls -->
  <div class="add-trip" style="display:inline-block; margin-left:1rem;">
    <label for="newTripName" style="margin-right:0.5rem;">
      ‚ûï Add trip:
    </label>
    <input id="newTripName"
           placeholder="e.g. 20251025 Paris"
           style="width:10rem; padding:0.25rem;" />
    <button class="btn" type="button" onclick="addTrip()">Add</button>
  </div>

  <!-- Delete Trip controls -->
  <div class="delete-trip" style="display:inline-block; margin-left:1rem;">
    <label for="deleteTripSelect" style="margin-right:0.5rem;">
      üóëÔ∏è Delete trip:
    </label>
    <select id="deleteTripSelect" style="padding:0.25rem;">
      <option value="">-- Select trip --</option>
    </select>
    <button class="btn" type="button" onclick="deleteTrip()">Delete</button>
  </div>
</div>

<!-- Status messages below the controls -->
<p id="addTripResult" style="margin-top:0.5rem; margin-bottom:0; font-size:12px; color:#333;"></p>
<p id="deleteResult" style="margin-top:0; margin-bottom:0.5rem; font-size:12px; color:#333;"></p>


<table id="dataTable">
  <thead></thead>
  <tbody></tbody>
</table>
<!--  END of Travel Expenses Section -->

<!-- START of IVA Claims Section -->
<h2>Receipts for IVA Claim</h2>
  <div class="controls">
  <a href="https://forms.gle/Efmbz5brKNyohqQe7" target="_blank" rel="noopener" class="btn">New Receipt</a>

  <button class="btn refresh-btn" type="button">Refresh</button>

  <label for="filterSelect" class="filter-label">
    Filter by claim:
    <select id="filterSelect">
      <option value="">-- All --</option>
    </select>
  </label>
  <p class="filter-label"><b>JALLC NIF:</b> 508462037</p>
  <p class="filter-label"><b>Tipo:</b> Functionarios de Embaixadas e Organismos Internacionais</p>
  <p class="filter-label"><b>My NIF:</b> 256120803</p>

</div>
<!-- END of IVA Claims Section -->

<script>
/* ========= CONFIG - Injected from .env via build script ========= */
const SPREADSHEET_ID = '1J4dldGjb3SktoVxQD3BKm-iX6RDAF7YjoLImm7-MIsg';
const SHEET_NAME = 'Travel!A:G';
const FILTER_COLUMN_INDEX = 0; // "Trip" column
const SHEETS_API_KEY = 'AIzaSyCkQIbYsNr6ooub1lJysGoSflG9bka0fbs';

/* --- DELETE endpoint config --- */
const DELETE_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzqnISjJdPgppeKBOUoV9NU5ZWIHsS-ftvMaaa_EhgJJg3nPwMrPwrp3L2rzwVKzjRgog/exec';
const DELETE_API_KEY = 'K9mP2xR7nQ4vL8wT6hY3jF5bN1cZ9sD4';
/* ============================ */


/* ---------- Load Sheet Data ---------- */
const endpoint = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(SHEET_NAME)}?key=${SHEETS_API_KEY}&majorDimension=ROWS`;
let allRows = [];

async function loadSheet() {
  const res = await fetch(endpoint);
  if (!res.ok) {
    console.error('Sheets API error', await res.text());
    return;
  }
  const j = await res.json();
  const rows = j.values || [];
  if (rows.length === 0) return;

  const headers = rows[0];
  headers[6] = "Link to File"; // rename column 7 header
  allRows = rows.slice(1);

  // build header row
  document.querySelector('#dataTable thead').innerHTML =
    '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

  // populate filter dropdown and delete dropdown with unique Trip names
  const set = new Set(allRows.map(r => (r[FILTER_COLUMN_INDEX] || '').trim()).filter(x => x !== ''));
  const sortedTrips = Array.from(set).sort();

  // Populate filter dropdown
  const filterSelect = document.getElementById('filterSelect');
  filterSelect.innerHTML = '<option value="">Show all trips</option>';
  sortedTrips.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val; opt.textContent = val;
    filterSelect.appendChild(opt);
  });

  // Populate delete dropdown
  const deleteSelect = document.getElementById('deleteTripSelect');
  deleteSelect.innerHTML = '<option value="">-- Select trip --</option>';
  sortedTrips.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val; opt.textContent = val;
    deleteSelect.appendChild(opt);
  });

  renderTable(allRows);
}

function renderTable(rows) {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    const cells = r.map((c, i) => {
      if (i === 6 && c) { // make column 7 a link
        const safeUrl = c.startsWith('http') ? c : 'https://' + c;
        return `<td><a href="${safeUrl}" target="_blank" rel="noopener">Link</a></td>`;
      }
      return `<td>${c}</td>`;
    }).join('');
    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });
}

document.getElementById('filterSelect').addEventListener('change', function() {
  const v = this.value;
  const filtered = v ? allRows.filter(r => (r[FILTER_COLUMN_INDEX] || '') === v) : allRows;
  renderTable(filtered);
});

document.querySelectorAll('.refresh-btn').forEach(btn => {
  btn.addEventListener('click', () => location.reload());
});

/* ---------- Add Trip Function ---------- */
async function addTrip() {
  const tripName = document.getElementById("newTripName").value.trim();
  if (!tripName) {
    alert("Please enter a trip name");
    return;
  }

  const resultEl = document.getElementById("addTripResult");
  resultEl.textContent = "Adding trip...";
  resultEl.style.color = '#333';

  try {
    const res = await fetch(DELETE_WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "addTrip",
        tripName: tripName,
        apiKey: DELETE_API_KEY
      })
    });

    const data = await res.json();
    if (data.success) {
      resultEl.textContent = `Trip "${data.tripName}" added to form dropdown.`;
      resultEl.style.color = '#2d7a2d';
      document.getElementById("newTripName").value = ''; // clear input
      loadSheet(); // refresh dropdowns
    } else {
      resultEl.textContent = `Error: ${data.error || "unknown"}`;
      resultEl.style.color = '#c72e2e';
    }
  } catch (err) {
    resultEl.textContent = "Network or permission error: " + err;
    resultEl.style.color = '#c72e2e';
  }
}

/* ---------- Delete Trip Function ---------- */
async function deleteTrip() {
  const trip = document.getElementById("deleteTripSelect").value.trim();
  if (!trip) {
    alert("Please select a trip to delete");
    return;
  }

  const resultEl = document.getElementById("deleteResult");
  resultEl.textContent = "Working‚Ä¶";

  try {
    const res = await fetch(DELETE_WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify({
        tripName: trip,
        apiKey: DELETE_API_KEY
      })
    });

    const data = await res.json();
    if (data.success) {
      resultEl.textContent =
        `Deleted ${data.deletedRows} expense row(s) for "${data.trip}". `
        + `${data.remainingTrips} trip(s) remain in list.`;
      resultEl.style.color = '#2d7a2d'; // green for success
      loadSheet(); // refresh table after deletion
    } else {
      resultEl.textContent = `Error: ${data.error || "unknown"}`;
      resultEl.style.color = '#c72e2e'; // red for error
    }
  } catch (err) {
    resultEl.textContent = "Network or permission error: " + err;
    resultEl.style.color = '#c72e2e'; // red for error
  }
}

/* ---------- Load data on page start ---------- */
loadSheet();
</script>


</body>
</html>
